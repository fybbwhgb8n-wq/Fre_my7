# One-Shot Robust Capon Fusion Configuration - K=4 (Haar Wavelet)
# ADMM-free one-shot solver with K=4 Haar subbands

# ============== Model Configuration ==============
model:
  backbone: unet
  base_channels: 32
  K: 4                          # Number of frequency streams (Haar: LL, LH, HL, HH)
  freq_mode: haar               # Options: low_high, haar, learnable

  # Fusion scales
  fusion_scales: ["decoder_last"]

# ============== Fusion Configuration ==============
fusion:
  kernel_size: 3                # Neighborhood size for covariance
  center_snapshots: true        # Subtract local mean

  # Guidance vector
  a0_mode: stage                # Options: fixed | stage | pixel
  a0_floor: 0.001               # Minimum a0 value

  # Uncertainty (diagonal recommended)
  uncert_mode: diag             # Options: diag | full
  sigma_max: 0.5                # Lower sigma_max for K=4 (more subbands = more potential instability)
  d: 4                          # Only for uncert_mode: full

# ============== Solver Configuration ==============
solver:
  gamma: 1.0                    # Robustness loading strength
  learn_gamma: true             # Whether to learn gamma
  gamma_min: 0.0                # Minimum gamma value

  # Covariance stabilization (slightly more conservative for K=4)
  cov_shrink: 0.15              # Higher shrinkage for K=4
  cov_delta: 0.005              # Higher loading for K=4
  jitter: 0.000001              # Cholesky jitter

  # Numerical stability
  use_double: true              # Use float64 for solve (CRITICAL for K=4)
  margin_eps: 0.0001            # Minimum margin before fallback
  fallback_mode: a0             # Options: a0 | uniform
  w_clip: 15.0                  # More conservative clipping for K=4
  detach_weights: false

# ============== Loss Configuration ==============
loss:
  # Segmentation loss
  lambda_dice: 1.0              # Weight for Dice loss

  # Augmented Lagrangian sparsity constraint
  use_al: true
  al_warmup_epochs: 25          # Slightly longer warmup for K=4
  al_rho: 10.0
  al_alpha: 2.5
  al_beta_pixels: 16

  # Isolation loss
  use_iso: true
  lambda_iso: 0.001
  iso_gamma: 2.0
  iso_kernel: 3

# ============== Training Configuration ==============
train:
  lr: 0.00015                   # Slightly lower LR for K=4
  weight_decay: 0.01
  epochs: 500                   # More epochs for K=4
  batch_size: 8

  # Gradient clipping (IMPORTANT)
  grad_clip: 1.0

  # Mixed precision
  amp: true

  # Scheduler
  scheduler: cosine
  warmup_epochs: 15             # Longer warmup
  min_lr: 0.00001

  # Validation
  val_interval: 5
  threshold: 0.5

# ============== Metrics Configuration ==============
metrics:
  min_area: 2

# ============== Dataset Configuration ==============
dataset:
  name: NUDT-SIRST
  root: ./dataset
  base_size: 256
  crop_size: 256

# ============== Hardware Configuration ==============
hardware:
  ngpu: 0
  multi_gpus: false
  num_workers: 8
  pin_memory: true

# ============== Reproducibility ==============
seed: 42

